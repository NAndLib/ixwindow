#!/bin/bash

usage () {
    printf "%s" "\
USAGE: 
    install [OPTIONS] [ARGS]

ARGS:
    <WM>
        Window managers, for which you want to install files.

OPTIONS:
    -h, --help
        Show this message.

    --prefix
        Used for specifying installation directory.

    --clean
        When specified, this script cleans destinational files from previous 
        installation.
"

exit 1
}


init_config_file () {
    cp --parents "examples/ixwindow.toml" "$XDG_CONFIG_HOME/ixwindow/ixwindow.toml"
}

install_wm () {
    local wm="$1"
   
    if [ "$CLEAN" -eq 1 ]; then
        rm -r "$PREFIX"
    fi

    case "$wm" in 
        "bspwm")
            cp -r "ixwindow/wms/bspwm" "ixwindow_compiled/bspwm"
            local config="$(echo "$XDG_CONFIG_HOME/ixwindow/ixwindow.toml" | sed -e 's/\\/\\\\/g; s/\//\\\//g; s/&/\\\&/g')" 
            sed -i "s/\$\$CONFIG/\"$config\"/g" ixwindow_compiled/bspwm/ixwindow
            ;;

        "i3")
            cp -r "ixwindow/wms/i3" "ixwindow_compiled/i3"

            cd ixwindow_compiled/i3 && cargo build --release  
            cd ../ && cp i3/target/release/ixwindow_i3 ./

            rm -r i3/*
            mv ixwindow_i3 i3/ixwindow
            cd ../
            ;;
    esac
    
    cp -r ixwindow_compiled/* "$PREFIX"
}

WINDOW_MANAGES=()

if [ $# -eq 0 ]; then
    usage
fi

CLEAN=0
PREFIX=""

while [ $# -gt 0 ];
do
    case "$1" in 
        "--help" | "-h")
            usage 
            ;;
        "--clean")
            CLEAN=1
            shift
            ;;
        "--prefix")
            PREFIX="$1"
            shift 1
            ;;
        *)
            while [ $# -gt 0 ]; 
            do
                WINDOW_MANAGES+=("$1")
                shift
            done

            ;;
    esac
done

cp -r ixwindow ixwindow_compiled
rm -r ixwindow_compiled/wms

g++ ixwindow_compiled/polybar-xwindow-icon.cpp -o ixwindow_compiled/polybar-xwindow-icon -I/usr/include/opencv4/ -lopencv_core -lopencv_videoio -lopencv_highgui -lopencv_imgcodecs -lopencv_imgproc -lX11

for wm in "${WINDOW_MANAGES[@]}"
do
    install_wm "$wm"
done


init_config_file 

rm -r ixwindow_compiled
